# Test create-pr-from-worktree Action
#
# Runs comprehensive tests on the create-pr-from-worktree composite action
# whenever related files are modified in a pull request.
#
# Triggered by:
# - Changes to action files (.github/actions/create-pr-from-worktree/**)
# - Changes to test script (scripts/test-actions.sh)
# - Changes to this workflow file
#
# Test Coverage:
# - Integration test with real GitHub API calls
# - Tests action validation flow (environment, branches)
# - Tests PR creation/update with test labels
# - Tests action outputs and error handling

name: "[E2E]Test create-pr Action"

permissions:
  contents: write # Required for git push operations (step 4)
  pull-requests: write # Required for creating/updating PRs via gh CLI

on:
  workflow_dispatch:

jobs:
  test-action:
    name: Test create-pr-from-worktree action
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 5
          persist-credentials: true

      - name: Setup test variables
        id: vars
        run: |
          base_branch=$(git symbolic-ref --short HEAD)  # Auto-detect base branch
          pr_branch="test/create_pr"

          # Fixed test values for integration testing
          {
            echo "PR_TITLE=create pr test"
            echo "BASE_BRANCH=${base_branch}"
            echo "PR_BRANCH=${pr_branch}"
            echo "LABELS=test,automated,integration-test"
            echo "MERGE_METHOD=never"
            echo "worktree-dir=${RUNNER_TEMP}/gitworktree/work-temp"
          } >> "$GITHUB_OUTPUT"

          # PR body with timestamp to verify updates
          {
            echo "PR_BODY<<EOF"
            echo "## Integration Test PR"
            echo ""
            echo "This PR is automatically created by the integration test workflow to verify the 'create-pr-from-worktree' action."
            echo ""
            echo "**Test Run Information:**"
            echo "- Workflow: ${{ github.workflow }}"
            echo "- Run ID: ${{ github.run_id }}"
            echo "- Run Number: ${{ github.run_number }}"
            echo "- Triggered by: ${{ github.event_name }}"
            echo "- Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            echo "**Branch Information:**"
            echo "- PR Branch: ${pr_branch}"
            echo "- Base Branch: ${base_branch}"
            echo ""
            echo "### Expected Behavior"
            echo ""
            echo "This action should:"
            echo "1. Detect the current branch (auto-detected)"
            echo "2. Validate environment (Linux, gh CLI, auth, rate limits)"
            echo "3. Validate branches (base and head exist on remote)"
            echo "4. Create or update this PR"
            echo "5. Add labels: test, automated, integration-test"
            echo "6. NOT enable auto-merge (merge_method=never)"
            echo ""
            echo "---"
            echo "Generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Initialize worktree with gitsign
        uses: ./.github/actions/pr-worktree-initialize
        id: init_worktree
        with:
          branch-name: ${{ steps.vars.outputs.PR_BRANCH }}
          worktree-dir: ${{ steps.vars.outputs.worktree-dir }}

      - name: add file for pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ${{ steps.vars.outputs.worktree-dir }}
          echo "#!/bin/bash" > test-create-pr.sh
          echo "echo 'This is a test file for create-pr-from-worktree action test.'" >> test-create-pr.sh
          git add test-create-pr.sh
          git commit -m "test: add test-create-pr.sh for create-pr-from-worktree action test"
          git push origin ${{ steps.vars.outputs.PR_BRANCH }} --force

      - name: Verify signed commit
        run: |
          cd ${{ steps.vars.outputs.worktree-dir }}
          echo "=== Commit Signature (pushed) ==="

          echo "cat-file"
          git cat-file -t HEAD

          # shallow clone か？
          echo "is-shallow-repository:"
          git rev-parse --is-shallow-repository
          echo ""
          # 署名付きか（gitsign/GPG 共通）
          git log -1 --show-signature

          echo "=== End of Commit Signature Verification ==="

      - name: create pr using composite action
        uses: ./.github/actions/create-pr-from-worktree
        id: create_pr
        with:
          pr-title: ${{ steps.vars.outputs.PR_TITLE }}
          pr-body: ${{ steps.vars.outputs.PR_BODY }}
          pr-branch: ${{ steps.vars.outputs.PR_BRANCH }}
          labels: ${{ steps.vars.outputs.LABELS }}
          merge-method: ${{ steps.vars.outputs.MERGE_METHOD }}

      - name: cleanup worktree
        if: always()
        run: |
          git worktree remove ${{ steps.vars.outputs.worktree-dir }} --force
