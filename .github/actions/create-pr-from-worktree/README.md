# Create PR from Worktree Action

A reusable composite action that creates or updates Pull Requests from
worktree with labels and auto-merge enabled.

**ü§ñ Designed for automated Bot workflows** - This action automatically
enables auto-merge. Ensure your organization's policies permit
auto-merge for Bot-generated PRs before use.

## Prerequisites

Before calling this action, ensure:

1. The base branch exists on the remote repository
2. Changes are committed to the current branch
3. Current branch is pushed to origin
4. You are on the branch you want to create a PR from (not in detached HEAD state)

This action focuses solely on GitHub PR operations - it does not perform
git operations like branch creation, commits, or pushes. The action automatically
detects the current branch as the PR head branch.

## Features

- **Automatic Branch Detection**: Auto-detects current branch as PR head - no manual branch name configuration needed
- **PR Creation/Update**: Creates new PRs or updates existing ones with
  title and body changes
- **Flexible Labeling**: Auto-creates labels if they don't exist and
  applies them to PRs
- **Auto-Merge Support**: Enables auto-merge with configurable merge
  methods (merge, squash, rebase)
- **Branch Validation**: Verifies branches exist on remote before creating PR
- **Idempotent**: Safe to run multiple times - updates existing PRs
  instead of failing
- **Native GitHub CLI**: Uses `gh` CLI for maximum flexibility and reliability

## Usage

### Basic Example

```yaml
# Create and push branch first
- name: Create PR branch
  run: |
    git checkout -b auto-fix/${{ github.ref_name }}
    git commit -m "fix: Auto-fix issues"
    git push origin auto-fix/${{ github.ref_name }}

# Then create the PR (head branch is auto-detected from current branch)
- name: Create Pull Request
  uses: ./.github/actions/create-pr-from-worktree
  with:
    base-branch: ${{ github.ref_name }}
    pr-title: "fix: Auto-fix issues"
    pr-body: "This PR automatically fixes detected issues."
    labels: "automated,fix"
    merge-method: "squash"
```

### Example with Manual Merge (No Auto-Merge)

```yaml
# Create PR without auto-merge for manual review
- name: Create PR branch
  run: |
    git checkout -b feature/${{ github.ref_name }}
    git commit -m "feat: Add new feature"
    git push origin feature/${{ github.ref_name }}

- name: Create Pull Request (manual merge required)
  uses: ./.github/actions/create-pr-from-worktree
  with:
    base-branch: ${{ github.ref_name }}
    pr-title: "feat: Add new feature"
    pr-body: "This PR requires manual review and approval."
    labels: "feature,needs-review"
    merge-method: "never"  # Disable auto-merge
```

### Advanced Example

````yaml
# Handle git operations
- name: Create and push PR branch
  run: |
    PR_BRANCH="auto-chmod/${{ github.ref_name }}"

    # Create or update branch
    if git ls-remote --heads origin "$PR_BRANCH" | grep -q "$PR_BRANCH"; then
      git fetch origin "$PR_BRANCH"
      git checkout -B "$PR_BRANCH" "origin/$PR_BRANCH"
    else
      git checkout -b "$PR_BRANCH"
    fi

    # Commit and push
    git config --local user.name "github-actions[bot]"
    git config --local user.email "github-actions[bot]@users.noreply.github.com"
    git commit -m "[Bot] ci(scripts): Fix shell script permissions"
    git push -f origin "$PR_BRANCH"

# Create PR with custom settings (head branch auto-detected)
- name: Create PR with auto-merge
  id: create_pr
  uses: ./.github/actions/create-pr-from-worktree
  with:
    base-branch: ${{ github.ref_name }}
    pr-title: "[Bot] ci(scripts): Fix shell script permissions"
    pr-body: |
      ## Auto-generated PR: Shell Script Permission Fix

      This PR automatically fixes executable permissions...

      ### Files Modified
      ```
      ${{ steps.chmod.outputs.changed_files }}
      ```

      ü§ñ Auto-generated by GitHub Actions
    labels: "automated,chore"
    merge-method: "squash"

- name: Check validation result and use outputs
  run: |
    STATUS="${{ steps.create_pr.outputs.validation-status }}"
    MESSAGE="${{ steps.create_pr.outputs.validation-message }}"

    if [ "$STATUS" = "fail" ] || [ "$STATUS" = "error" ]; then
      echo "::error::PR creation skipped: $MESSAGE"
      exit 1
    fi

    if [ "$STATUS" = "warning" ]; then
      echo "::warning::PR created with warnings: $MESSAGE"
    fi

    echo "PR Number: ${{ steps.create_pr.outputs.pr-number }}"
    echo "PR URL: ${{ steps.create_pr.outputs.pr-url }}"
    echo "Operation: ${{ steps.create_pr.outputs.pr-operation }}"
````

### Validation Handling Example

The action follows a **fail-first design** and **does not fail the workflow** even if
validation fails. Instead, it sets the `validation-status` and `validation-message`
outputs, allowing you to handle errors gracefully. PR creation only proceeds when all
validations return `ok`:

```yaml
- name: Create PR
  id: create_pr
  uses: ./.github/actions/create-pr-from-worktree
  with:
    base-branch: main
    pr-title: "New feature"
    pr-body: "Description"

# Option 1: Fail the job if validation failed
- name: Check validation
  if: steps.create_pr.outputs.validation-status != 'ok'
  run: |
    echo "::error::Validation failed: ${{ steps.create_pr.outputs.validation-message }}"
    exit 1

# Option 2: Skip subsequent steps if validation failed
- name: Post-PR tasks
  if: steps.create_pr.outputs.validation-status == 'ok'
  run: echo "PR created successfully"

# Option 3: Handle different validation statuses
- name: Handle validation result
  run: |
    STATUS="${{ steps.create_pr.outputs.validation-status }}"
    MESSAGE="${{ steps.create_pr.outputs.validation-message }}"

    case "$STATUS" in
      ok)
        echo "‚úì Validation passed and PR created"
        ;;
      warning)
        echo "::warning::Validation warning (PR not created): $MESSAGE"
        ;;
      fail)
        echo "::error::Validation failed (PR not created): $MESSAGE"
        exit 1
        ;;
      error)
        echo "::error::System error (PR not created): $MESSAGE"
        exit 1
        ;;
    esac
```

## Inputs

<!-- markdownlint-disable MD013 -->

| Input          | Description                                                            | Required | Default      |
| -------------- | ---------------------------------------------------------------------- | -------- | ------------ |
| `base-branch`  | Base branch name (target branch for PR)                                | Yes      | -            |
| `pr-title`     | Pull request title                                                     | Yes      | -            |
| `pr-body`      | Pull request body/description                                          | Yes      | -            |
| `labels`       | Comma-separated labels to add                                          | No       | `''` (empty) |
| `merge-method` | Auto-merge method (`merge`/`squash`/`rebase`/`never`). Use `never` to disable auto-merge. | No       | `squash`     |

<!-- markdownlint-enable MD013 -->

## Outputs

<!-- markdownlint-disable MD013 -->

| Output               | Description                                                           |
| -------------------- | --------------------------------------------------------------------- |
| `validation-status`  | Validation result (`ok`, `fail`, `error`, `warning`)                  |
| `validation-message` | Validation status message (provides details about validation results) |
| `pr-number`          | Created/updated PR number                                             |
| `pr-url`             | Pull request URL                                                      |
| `pr-operation`       | Operation performed (`created`, `updated`, `none`)                    |

<!-- markdownlint-enable MD013 -->

**Validation Status Values**:

- `ok`: All validations passed successfully
- `fail`: User-fixable validation failure (missing branches, invalid parameters)
- `error`: System/runtime error (API failures, authentication failures)
- `warning`: Validation passed with warnings (e.g., low API rate limit)

**Note**: This action follows a **fail-first design**. PR creation only proceeds when
all validation steps return `ok` status. If any validation returns `fail`, `error`, or
`warning`, the PR creation steps are skipped, and `pr-number`, `pr-url`, and
`pr-operation` will be empty. This ensures PRs are only created in fully validated
environments.

## Branch Requirements

The action requires both base and current branches to already exist
on the remote repository. The action:

1. Auto-detects the current branch as the PR head branch
2. Validates:
   - Base branch exists on remote
   - Current branch exists on remote
   - Base and current branches are different

**Example branch configuration**:

- Checked out on `auto-fix/main` + `base-branch: main` creates PR from
  `auto-fix/main` ‚Üí `main`
- Checked out on `auto-chmod/feat/new-feature` + `base-branch: feat/new-feature`
  creates PR from `auto-chmod/feat/new-feature` ‚Üí `feat/new-feature`

**Important**: You must be on a checked-out branch. Detached HEAD state will
cause the action to fail with an error.

## Label Management

Labels specified in the `labels` input are:

1. Created automatically if they don't exist (using `gh label create --force`)
2. Applied to the PR
3. Comma-separated (e.g., `"automated,chore,fix"`)

**Note**: Labels are created with default colors. To customize label
colors, create them manually in the repository settings first.

## Auto-Merge Behavior

The action can enable auto-merge with the specified method:

- `squash` (default): Squash commits into one
- `merge`: Standard merge commit
- `rebase`: Rebase and merge
- `never`: Disable auto-merge (PR created without auto-merge enabled)

**When auto-merge is enabled** (`squash`/`merge`/`rebase`):

- Repository must have auto-merge enabled in settings
- Branch protection rules must be satisfied
- Required status checks must pass
- Required approvals must be received
- The PR will automatically merge once all conditions are met

**When auto-merge is disabled** (`never`):

- PR is created or updated normally
- Labels are applied if specified
- Auto-merge is NOT enabled
- Manual merge or approval required

**‚ö†Ô∏è Organization Policy Warning**:

This action is designed for **automated Bot workflows only**. Some
organizations have policies prohibiting auto-merge. Before using this
action:

- Verify your organization allows auto-merge for Bot PRs
- Check if specific merge methods (squash/merge/rebase) are restricted
- Ensure compliance with your team's code review policies
- Consider using `merge-method: "squash"` as the safest default

## Requirements

### Repository Settings

1. **Auto-merge enabled**: Settings ‚Üí General ‚Üí Allow auto-merge
2. **Branch protection** (recommended): Protect base branches with
   required checks

### Workflow Permissions

The workflow must have `contents: write` permission:

```yaml
permissions:
  contents: write
  pull-requests: write # Usually included in contents: write
```

### Authentication

The action automatically uses the workflow's `GITHUB_TOKEN` for all GitHub CLI operations. No explicit token configuration is required.

**For advanced scenarios requiring PAT tokens**, set the `GH_TOKEN` environment variable at the workflow level:

```yaml
env:
  GH_TOKEN: ${{ secrets.PAT_TOKEN }}

steps:
  - uses: ./.github/actions/create-pr-from-worktree
    # Will inherit GH_TOKEN from workflow env
```

## How It Works

1. **Detect Branch**: Auto-detects current branch name for PR head
2. **Validate Environment**: Verifies OS, GitHub CLI, and API rate limits (fail-first: must be `ok`)
3. **Validate Branches**: Verifies base and current branches exist on remote
   and are different (fail-first: must be `ok`)
4. **Create/Update PR**: Creates new PR or updates existing one with
   title and body (only if all validations are `ok`)
5. **Apply Labels**: Creates labels if needed and applies them (only if all validations are `ok`)
6. **Enable Auto-Merge**: Configures auto-merge with specified method (only if `merge-method` is not `never`)

## Limitations

- **Requires pre-pushed branches**: Both base and current branches must
  already exist on remote
- **Requires checked-out branch**: Cannot run in detached HEAD state
- **No git operations**: The action does not create branches, commit
  changes, or push code
- **Single PR per branch pair**: One PR from current branch to
  base branch at a time
- **Linux only**: The action runs on Linux runners only

## Troubleshooting

### "Failed to detect current branch name"

This error occurs when running in detached HEAD state. Ensure you have a checked-out branch:

```yaml
# Bad: Detached HEAD state
- run: git checkout HEAD~1

# Good: Checked out branch
- run: git checkout -b my-pr-branch
```

If you need to switch branches in your workflow, ensure you check out the PR branch before calling this action:

```yaml
- name: Switch to PR branch
  run: git checkout my-pr-branch

- name: Create PR
  uses: ./.github/actions/create-pr-from-worktree
  with:
    base-branch: main
    # head branch auto-detected as my-pr-branch
```

### "Branch does not exist on remote"

Ensure branches are pushed before calling this action:

```yaml
- name: Create and push branch
  run: |
    git checkout -b my-pr-branch
    git commit -m "My changes"
    git push origin my-pr-branch

- name: Create PR
  uses: ./.github/actions/create-pr-from-worktree
  with:
    base-branch: main
    # head branch auto-detected as my-pr-branch
```

### Auto-merge not working

Check:

1. Repository has auto-merge enabled
2. Branch protection rules are satisfied
3. Required status checks are passing
4. Required approvals are received

### Labels not created

The action creates labels with `--force` flag. If this fails:

1. Check workflow token has sufficient permissions (`pull-requests: write`)
2. Verify repository settings allow label creation

## Related Documentation

- [GitHub CLI Manual](https://cli.github.com/manual/)
- [GitHub Auto-Merge Documentation](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request)
- [Composite Actions Guide](https://docs.github.com/en/actions/creating-actions/creating-a-composite-action)

## License

MIT License - Copyright (c) 2025 atsushifx
